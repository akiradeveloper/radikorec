#!/usr/bin/env python

import os
import commands
from argparse import ArgumentParser

import radiru
import radiko

class Config: 
	def __init__(self, args):
		self.args = args	

		self.duration_sec = 60 * args.duration + 30
		if args.test:
			self.duration_sec = 15
		
		self.P("\n--**-- %s --**--" % commands.getoutput("date -u"))
		
		date = commands.getoutput("TZ=JST-9 date +'%Y-%m-%d-%H-%M'")
		
		self.filename = "/".join( [args.directory, "%s-%s.m4a" % (args.prefix, date)] ) 
		if args.test:
			self.filename = "/tmp/RADIKOREC.m4a"
		self.P(self.filename)
		
	def P(self, msg):
		LOGFILE = "/tmp/radikorec.log"
		f = open(LOGFILE, "a")
		f.write(str(msg) + "\n")
		f.close
		
		if self.args.debug:
			print(msg)
			
	def R(self, command):
		if self.args.dry_run:
			return os.system(command)

if __name__ == '__main__':
	parser = ArgumentParser(description="A Simple Radiko Recorder")
	
	parser.add_argument('--duration', type=int, default=1, help="time(min) to record. default(1)")
	parser.add_argument('--prefix', default='RADIKOREC', help="filename prefix. default(RADIKOREC)")
	parser.add_argument('--rtmpbin', default='rtmpdump', help="The path for rtmpdump binary >= 2.4. default(rtmpdump)")
	parser.add_argument('--channel', default='FM', help="FM|NHK1|NHK2. default(FM)")
	parser.add_argument('--directory', default='/tmp', help="output directory. default(/tmp)")
	parser.add_argument('--test', action='store_true', default=False, help="set test parameters.")
	parser.add_argument('--debug', action='store_true', default=True, help="print messages on console.")
	parser.add_argument('--dry-run', action='store_true', default=False, help="don't actually execute")
	
	args = parser.parse_args()
	
	config = Config(args)
	config.P(args)

	command1 = None
	if radiru.CHANNEL_MAP.has_key(args.channel):
		command1 = radiru.getCommand1(config)
		
	if radiko.CHANNEL_MAP.has_key(args.channel):
		command1 = radiko.getCommand1(config)
		
	if command1 is None:
		config.P("ERROR channel not valid")
		exit(1)
		
	config.P(command1)
	r = config.R(command1)
	if r > 0:
		config.P("ERROR command1")
		exit(1)
	
	# fix the file
	config.R("mv %s %s.raw" % (config.filename, config.filename))
	command2 = "ffmpeg -i %s.raw -acodec copy %s".strip() % (config.filename, config.filename)
	config.P(command2)

	r = config.R(command2)
	if r > 0:
		config.P("ERROR command2")
	
	config.R("rm %s.raw" % config.filename)
